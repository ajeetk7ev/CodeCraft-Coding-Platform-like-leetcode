name: Secure Deploy CodeArena

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          VPS_PATH: ${{ secrets.VPS_PATH }}
          MONGO_URI: ${{ secrets.MONGO_URI }}
          PORT: ${{ secrets.PORT }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          JUDGE0_API_URL: ${{ secrets.JUDGE0_API_URL }}
          JUDGE0_RAPIDAPI_KEY: ${{ secrets.JUDGE0_RAPIDAPI_KEY }}
          JUDGE0_RAPIDAPI_HOST: ${{ secrets.JUDGE0_RAPIDAPI_HOST }}
          JUDGE0_URL: ${{ secrets.JUDGE0_URL }}
          REDIS_HOST: ${{ secrets.REDIS_HOST }}
          REDIS_PORT: ${{ secrets.REDIS_PORT }}
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
          CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
          CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          debug: true
          script: |
            set -e

            echo "ðŸš€ Starting secure deployment"

            # ===============================
            # ðŸ“ NAVIGATE & UPDATE
            # ===============================
            cd "$VPS_PATH" || exit 1
            git pull origin main

            # ===============================
            # ðŸŒ NODE (NVM)
            # ===============================
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
            nvm use 24.12.0 || nvm install 24.12.0

            # ===============================
            # ðŸ” BACKEND ENV
            # ===============================
            cat > backend/.env <<'EOF'
            MONGO_URI=$MONGO_URI
            PORT=$PORT
            JWT_SECRET=$JWT_SECRET
            JUDGE0_API_URL=$JUDGE0_API_URL
            JUDGE0_RAPIDAPI_KEY=$JUDGE0_RAPIDAPI_KEY
            JUDGE0_RAPIDAPI_HOST=$JUDGE0_RAPIDAPI_HOST
            JUDGE0_URL=$JUDGE0_URL
            REDIS_HOST=$REDIS_HOST
            REDIS_PORT=$REDIS_PORT
            REDIS_PASSWORD=$REDIS_PASSWORD
            CLOUDINARY_CLOUD_NAME=$CLOUDINARY_CLOUD_NAME
            CLOUDINARY_API_KEY=$CLOUDINARY_API_KEY
            CLOUDINARY_API_SECRET=$CLOUDINARY_API_SECRET
            OPENROUTER_API_KEY=$OPENROUTER_API_KEY
            EOF

            # ===============================
            # ðŸŽ¨ FRONTEND ENV (VITE)
            # ===============================
            cat > frontend/.env.production <<'EOF'
            VITE_API_URL=$VITE_API_URL
            EOF

            # ===============================
            # ðŸ”§ BACKEND
            # ===============================
            cd backend
            npm ci
            npm run build
            pm2 restart codearena-backend --update-env || pm2 start dist/server.js --name codearena-backend

            # ===============================
            # ðŸŽ¨ FRONTEND
            # ===============================
            cd ../frontend
            npm ci
            npm run build

            sudo rm -rf /var/www/codearena/*
            sudo cp -r dist/* /var/www/codearena/
            sudo chown -R www-data:www-data /var/www/codearena
            sudo chmod -R 755 /var/www/codearena

            sudo nginx -t
            sudo systemctl reload nginx

            echo "âœ… Deployment completed successfully"
